---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 
#https://stackoverflow.com/questions/42047896/joining-a-dendrogram-and-a-heatmap
https://yulab-smu.top/treedata-book/chapter12.html
https://ggplot2-book.org/facet.html

```{r}
subset_sum_join_outputCCFdata
treatmentDendrogram
# draw_treatmentDendrogram

# dend_CCF <- dendro_data(treatmentDendrogram)

# mCCF_lagZero

test_sample_names <- colnames(mCCF_lagZero)

# Setup the data, so that the layout is inverted (this is more 
# "clear" than simply using coord_flip())
test_segment_data <- with(
    segment(dend_CCF), 
    data.frame(x = y, y = x, xend = yend, yend = xend))


# Use the dendrogram label data to position the gene labels
test_gene_pos_table <- with(
    dend_CCF$labels, 
    data.frame(y_center = x, gene = as.character(label), height = 1))



# Table to position the samples
test_sample_pos_table <- data.frame(sample = test_sample_names) %>%
    dplyr::mutate(x_center = (1:n()), width = 1)

# Neglecting the gap parameters
heatmap_data <- mat %>% 
    reshape2::melt(value.name = "expr", varnames = c("gene", "sample")) %>%
    left_join(gene_pos_table) %>%
    left_join(sample_pos_table)


```

https://yulab-smu.top/treedata-book/chapter12.html
https://ggplot2-book.org/facet.html
```{r}
# For the full dendrogram
library(plyr)
library(reshape2)
library(dplyr)
library(ggplot2)
library(ggdendro)
library(gridExtra)
library(dendextend)

set.seed(10)

# The source data
# mat <- matrix(rnorm(24 * 10, mean = 1, sd = 2), 
#               nrow = 24, ncol = 10, 
#               dimnames = list(paste("g", 1:24, sep = ""), 
#                               paste("sample", 1:10, sep = "")))

mat <- mCCF_lagZero

sample_names <- rownames(mat)

# Obtain the dendrogram
dend <- as.dendrogram(hclust(dist(mat)))
dend <- treatmentDendrogram
dend_data <- dendro_data(dend)

dend

# Setup the data, so that the layout is inverted (this is more 
# "clear" than simply using coord_flip())
segment_data <- with(
    segment(dend_data), 
    data.frame(x = y, y = x, xend = yend, yend = xend))
# Use the dendrogram label data to position the gene labels
treat_pos_table <- with(
    dend_data$labels, 
    data.frame(y_center = x, treat = as.character(label), height = 1))
treat_pos_table
# Table to position the sample

feat_pos_table <- data.frame(feat = sample_names) %>%
    dplyr::mutate(x_center = (1:n()), 
           width = 1)
feat_pos_table

mat

# Neglecting the gap parameters
heatmap_data <- mat %>% 
    reshape2::melt(value.name = "geomMeasure", varnames = c("feat", "treat")) %>%
      left_join(treat_pos_table) %>%
      left_join(feat_pos_table)
heatmap_data

# Limits for the vertical axes
treat_axis_limits <- with(
    treat_pos_table, 
    c(min(y_center - 0.5 * height), max(y_center + 0.5 * height))
) + 
    0.1 * c(-1, 1) # extra spacing: 0.1

# Heatmap plot
plt_hmap <- ggplot(heatmap_data, 
                   aes(x = x_center, y = y_center, fill = geomMeasure, 
                       height = height, width = width)) + 
    geom_tile() +
    scale_fill_gradient2("geomMeasure", high = "darkred", low = "darkblue") +
    scale_x_continuous(breaks = feat_pos_table$x_center, 
                       labels = feat_pos_table$sample, 
                       expand = c(0, 0)) + 
    # For the y axis, alternatively set the labels as: gene_position_table$gene
    scale_y_continuous(breaks = treat_pos_table[, "y_center"], 
                       labels = rep("", nrow(treat_pos_table)),
                       limits = treat_axis_limits, 
                       expand = c(0, 0)) + 
    labs(x = "Sample", y = "") +
    theme_bw() +
    theme(axis.text.x = element_text(size = rel(1), hjust = 1, angle = 45), 
          # margin: top, right, bottom, and left
          plot.margin = unit(c(1, 0.2, 0.2, -0.7), "cm"), 
          panel.grid.minor = element_blank())

####hybrid ###
plt_hmap <- ggplot(heatmap_data, 
                   aes(x = x_center, y = y_center, fill = geomMeasure, 
                       height = height, width = width)) + 
    geom_tile() +
    scale_fill_gradient2("geomMeasure", high = "darkred", low = "darkblue") +
    scale_x_continuous(breaks = feat_pos_table$x_center, 
                       labels = feat_pos_table$sample, 
                       expand = c(0, 0)) + 
    # For the y axis, alternatively set the labels as: gene_position_table$gene
    scale_y_continuous(breaks = treat_pos_table[, "y_center"], 
                       labels = rep("", nrow(treat_pos_table)),
                       limits = treat_axis_limits, 
                       expand = c(0, 0)) + 
    labs(x = "Sample", y = "") +
    theme_bw() +
    theme(axis.text.x = element_text(size = rel(1), hjust = 1, angle = 45), 
          # margin: top, right, bottom, and left
          plot.margin = unit(c(1, 0.2, 0.2, -0.7), "cm"), 
          panel.grid.minor = element_blank())


###
heatmap_CCF <- ggplot(subset_sum_join_outputCCFdata[,],
       aes(x =subset_sum_join_outputCCFdata$anCCF_LAG, y = subset_sum_join_outputCCFdata$anCCF_ACF, group = subset_sum_join_outputCCFdata$an_CCF_ObjectID))+
  geom_rect(data=subset_sum_join_outputCCFdata, aes(ymin=-1, ymax=1, xmin=-15,
                                                    xmax=15, fill=subset_sum_join_outputCCFdata$meanLAGzero, color = subset_sum_join_outputCCFdata$meanLAGzero), alpha =0.1)+

  geom_line(alpha = 0.5)+
  scale_color_viridis_c(option ="magma")+
  scale_fill_viridis_c(option ="magma")+
  facet_grid( vars(an_CCF_Feature),vars(Treatment) )+
  stat_summary(aes(y = subset_sum_join_outputCCFdata$anCCF_ACF,group=1), fun.y=mean, colour="darkorange", geom="line",group=1, size = 1)+
  theme_classic() +
  theme(legend.position="bottom")
heatmap_CCF
####

# Dendrogram plot
plt_dendr <- ggplot(segment_data) + 
    geom_segment(aes(x = x, y = y, xend = xend, yend = yend)) + 
    scale_x_reverse(expand = c(0, 0.5)) + 
    scale_y_continuous(breaks = treat_pos_table$y_center, 
                       labels = treat_pos_table$treat, 
                       limits = treat_axis_limits, 
                       expand = c(0, 0)) + 
    labs(x = "Distance", y = "", colour = "", size = "") +
    theme_bw() + 
    theme(panel.grid.minor = element_blank())

library(cowplot)
plot_grid(plt_dendr, plt_hmap, align = 'h', rel_widths = c(1, 1))
```

```{r}
# For the full dendrogram
library(plyr)
library(reshape2)
library(dplyr)
library(ggplot2)
library(ggdendro)
library(gridExtra)
library(dendextend)

set.seed(10)

# The source data
mat <- matrix(rnorm(24 * 10, mean = 1, sd = 2), 
              nrow = 24, ncol = 10, 
              dimnames = list(paste("g", 1:24, sep = ""), 
                              paste("sample", 1:10, sep = "")))
mat
sample_names <- colnames(mat)

# Obtain the dendrogram
dend <- as.dendrogram(hclust(dist(mat)))
dend_data <- dendro_data(dend)

# Setup the data, so that the layout is inverted (this is more 
# "clear" than simply using coord_flip())
segment_data <- with(
    segment(dend_data), 
    data.frame(x = y, y = x, xend = yend, yend = xend))

# Use the dendrogram label data to position the gene labels
gene_pos_table <- with(
    dend_data$labels, 
    data.frame(y_center = x, gene = as.character(label), height = 1))
gene_pos_table
# Table to position the sample

sample_pos_table <- data.frame(sample = sample_names) %>%
    dplyr::mutate(x_center = (1:n()), 
           width = 1)
sample_pos_table

mat

# Neglecting the gap parameters
heatmap_data <- mat %>% 
    reshape2::melt(value.name = "expr", varnames = c("gene", "sample")) %>%
    left_join(gene_pos_table) %>%
    left_join(sample_pos_table)
heatmap_data

# Limits for the vertical axes
gene_axis_limits <- with(
    gene_pos_table, 
    c(min(y_center - 0.5 * height), max(y_center + 0.5 * height))
) + 
    0.1 * c(-1, 1) # extra spacing: 0.1

# Heatmap plot
plt_hmap <- ggplot(heatmap_data, 
                   aes(x = x_center, y = y_center, fill = expr, 
                       height = height, width = width)) + 
    geom_tile() +
    scale_fill_gradient2("expr", high = "darkred", low = "darkblue") +
    scale_x_continuous(breaks = sample_pos_table$x_center, 
                       labels = sample_pos_table$sample, 
                       expand = c(0, 0)) + 
    # For the y axis, alternatively set the labels as: gene_position_table$gene
    scale_y_continuous(breaks = gene_pos_table[, "y_center"], 
                       labels = rep("", nrow(gene_pos_table)),
                       limits = gene_axis_limits, 
                       expand = c(0, 0)) + 
    labs(x = "Sample", y = "") +
    theme_bw() +
    theme(axis.text.x = element_text(size = rel(1), hjust = 1, angle = 45), 
          # margin: top, right, bottom, and left
          plot.margin = unit(c(1, 0.2, 0.2, -0.7), "cm"), 
          panel.grid.minor = element_blank())

# Dendrogram plot
plt_dendr <- ggplot(segment_data) + 
    geom_segment(aes(x = x, y = y, xend = xend, yend = yend)) + 
    scale_x_reverse(expand = c(0, 0.5)) + 
    scale_y_continuous(breaks = gene_pos_table$y_center, 
                       labels = gene_pos_table$gene, 
                       limits = gene_axis_limits, 
                       expand = c(0, 0)) + 
    labs(x = "Distance", y = "", colour = "", size = "") +
    theme_bw() + 
    theme(panel.grid.minor = element_blank())

library(cowplot)
plot_grid(plt_dendr, plt_hmap, align = 'h', rel_widths = c(1, 1))
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.
